<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - Micasita</title>
  <link rel="stylesheet" href="estilos.css">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--color-secundario);
      padding-bottom: 20px;
      gap: 20px;
    }

    .btn-logout {
      padding: 10px 16px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      white-space: nowrap;
    }

    .btn-logout:hover {
      background: #ff5252;
    }

    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 10px 20px;
      border: 2px solid var(--color-secundario);
      background: white;
      color: var(--color-secundario);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .tab-btn.activo {
      background: var(--color-secundario);
      color: white;
    }

    .tab-btn:hover {
      background: var(--color-secundario);
      color: white;
    }

    .tab-content {
      display: none;
      padding: 20px;
      background: rgba(243, 88, 186, 0.04);
      border-radius: 12px;
      border: 1px solid rgba(243, 88, 186, 0.1);
    }

    .tab-content.activo {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--color-text);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: var(--fuente-principal);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--color-secundario);
      box-shadow: 0 0 0 3px rgba(243, 88, 186, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .preview-imagen {
      max-width: 150px;
      max-height: 150px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .btn-grupo {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-guardar {
      flex: 1;
      padding: 12px;
      background: var(--color-secundario);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn-guardar:hover {
      background: var(--color-hover);
    }

    .btn-cancelar {
      flex: 1;
      padding: 12px;
      background: #ddd;
      color: var(--color-text);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn-cancelar:hover {
      background: #ccc;
    }

    .lista-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .item-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      transition: box-shadow 0.3s ease;
    }

    .item-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .item-imagen {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .item-titulo {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--color-text);
    }

    .item-info {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 12px;
    }

    .btn-acciones {
      display: flex;
      gap: 8px;
    }

    .btn-editar,
    .btn-eliminar {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }

    .btn-editar {
      background: var(--color-secundario);
      color: white;
    }

    .btn-editar:hover {
      background: var(--color-hover);
    }

    .btn-eliminar {
      background: #ff6b6b;
      color: white;
    }

    .btn-eliminar:hover {
      background: #ff5252;
    }

    .sin-contenido {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .mensaje-exito,
    .mensaje-error {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 2000;
      animation: deslizar 0.3s ease;
    }

    .mensaje-exito {
      background: #4caf50;
      color: white;
    }

    .mensaje-error {
      background: #ff6b6b;
      color: white;
    }

    @keyframes deslizar {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .btn-volver {
      display: inline-block;
      margin-bottom: 20px;
      padding: 10px 16px;
      background: var(--color-secundario);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    .btn-volver:hover {
      background: var(--color-hover);
    }

    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .admin-tabs {
        flex-wrap: wrap;
        width: 100%;
      }

      .tab-btn {
        flex: 1 1 auto;
        min-width: 100px;
      }

      .lista-items {
        grid-template-columns: 1fr;
      }

      .btn-acciones {
        flex-direction: column;
      }

      .btn-editar,
      .btn-eliminar {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <a href="index.html" class="btn-volver">‚Üê Volver a inicio</a>

    <div class="admin-header">
      <div>
        <h1>Panel de Administraci√≥n</h1>
        <p>Gestiona categor√≠as y productos</p>
      </div>
      <button class="btn-logout" onclick="logout()">Cerrar sesi√≥n</button>
    </div>

    <div class="admin-tabs">
      <button class="tab-btn activo" onclick="cambiarTab('categorias')">Categor√≠as</button>
      <button class="tab-btn" onclick="cambiarTab('productos')">Productos</button>
    </div>

    <!-- TAB CATEGOR√çAS -->
    <div id="tab-categorias" class="tab-content activo">
      <h2>Gestionar Categor√≠as</h2>

      <form id="form-categoria">
        <input type="hidden" id="cat-id">
        <div class="form-group">
          <label>Nombre de categor√≠a</label>
          <input type="text" id="cat-nombre" required>
        </div>
        <div class="form-group">
          <label>Imagen de categor√≠a</label>
          <input type="file" id="cat-imagen" accept="image/*">
          <img id="cat-preview" class="preview-imagen" style="display:none;">
        </div>
        <div class="btn-grupo">
          <button type="submit" class="btn-guardar" id="btn-guardar-cat">Agregar categor√≠a</button>
          <button type="button" class="btn-cancelar" onclick="limpiarFormCategoria()" style="display:none;" id="btn-cancelar-cat">Cancelar</button>
        </div>
      </form>

      <div id="lista-categorias" class="lista-items"></div>
    </div>

    <!-- TAB PRODUCTOS -->
    <div id="tab-productos" class="tab-content">
      <h2>Gestionar Productos</h2>

      <form id="form-producto">
        <input type="hidden" id="prod-id">
        <div class="form-group">
          <label>Nombre del producto</label>
          <input type="text" id="prod-nombre" required>
        </div>
        <div class="form-group">
          <label>Precio</label>
          <input type="number" id="prod-precio" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Categor√≠a</label>
          <select id="prod-categoria" required>
            <option value="">Selecciona una categor√≠a</option>
          </select>
        </div>
        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea id="prod-descripcion"></textarea>
        </div>
        <div class="form-group">
          <label>Imagen del producto</label>
          <input type="file" id="prod-imagen" accept="image/*">
          <img id="prod-preview" class="preview-imagen" style="display:none;">
        </div>
        <div class="btn-grupo">
          <button type="submit" class="btn-guardar" id="btn-guardar-prod">Agregar producto</button>
          <button type="button" class="btn-cancelar" onclick="limpiarFormProducto()" style="display:none;" id="btn-cancelar-prod">Cancelar</button>
        </div>
      </form>

      <div id="lista-productos" class="lista-items"></div>
    </div>
  </div>

  <script src="admin.js"></script>
  <script>
    // Variables globales
    let editandoCategoria = null;
    let editandoProducto = null;

    // Cambiar entre tabs
    function cambiarTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('activo'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('activo'));
      document.getElementById(`tab-${tab}`).classList.add('activo');
      event.target.classList.add('activo');
      
      if (tab === 'productos') {
        cargarSelectCategorias();
        mostrarProductos();
      } else {
        mostrarCategorias();
      }
    }

    // === CATEGOR√çAS ===
    document.getElementById('form-categoria').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('cat-id').value;
      const nombre = document.getElementById('cat-nombre').value;
      const inputImagen = document.getElementById('cat-imagen');

      if (!nombre) {
        mostrarMensaje('Completa todos los campos', 'error');
        return;
      }

      if (inputImagen.files.length === 0 && !id) {
        mostrarMensaje('Selecciona una imagen', 'error');
        return;
      }

      if (inputImagen.files.length > 0) {
        convertirImagenABase64(inputImagen.files[0], function(base64) {
          if (id) {
            DataManager.editarCategoria(id, nombre, base64);
            mostrarMensaje('Categor√≠a actualizada', 'exito');
          } else {
            DataManager.agregarCategoria(nombre, base64);
            mostrarMensaje('Categor√≠a agregada', 'exito');
          }
          limpiarFormCategoria();
          mostrarCategorias();
        });
      } else if (id) {
        const categorias = DataManager.cargarCategorias();
        const cat = categorias.find(c => c.id === id);
        DataManager.editarCategoria(id, nombre, cat.imagen);
        mostrarMensaje('Categor√≠a actualizada', 'exito');
        limpiarFormCategoria();
        mostrarCategorias();
      }
    });

    function mostrarCategorias() {
      const categorias = DataManager.cargarCategorias();
      const contenedor = document.getElementById('lista-categorias');

      if (categorias.length === 0) {
        contenedor.innerHTML = '<div class="sin-contenido">No hay categor√≠as a√∫n</div>';
        return;
      }

      contenedor.innerHTML = categorias.map(cat => `
        <div class="item-card">
          <img src="${cat.imagen}" alt="${cat.nombre}" class="item-imagen">
          <div class="item-titulo">${cat.nombre}</div>
          <div class="btn-acciones">
            <button class="btn-editar" onclick="editarCategoria('${cat.id}')">Editar</button>
            <button class="btn-eliminar" onclick="eliminarCategoria('${cat.id}')">Eliminar</button>
          </div>
        </div>
      `).join('');
    }

    function editarCategoria(id) {
      const categorias = DataManager.cargarCategorias();
      const cat = categorias.find(c => c.id === id);
      
      document.getElementById('cat-id').value = id;
      document.getElementById('cat-nombre').value = cat.nombre;
      document.getElementById('cat-preview').src = cat.imagen;
      document.getElementById('cat-preview').style.display = 'block';
      document.getElementById('btn-guardar-cat').textContent = 'Actualizar categor√≠a';
      document.getElementById('btn-cancelar-cat').style.display = 'block';
      
      editandoCategoria = id;
      window.scrollTo(0, 0);
    }

    function eliminarCategoria(id) {
      if (confirm('¬øEliminar esta categor√≠a? Los productos asociados se mantendr√°n.')) {
        DataManager.eliminarCategoria(id);
        mostrarMensaje('Categor√≠a eliminada', 'exito');
        mostrarCategorias();
      }
    }

    function limpiarFormCategoria() {
      document.getElementById('form-categoria').reset();
      document.getElementById('cat-id').value = '';
      document.getElementById('cat-preview').style.display = 'none';
      document.getElementById('btn-guardar-cat').textContent = 'Agregar categor√≠a';
      document.getElementById('btn-cancelar-cat').style.display = 'none';
      editandoCategoria = null;
    }

    // === PRODUCTOS ===
    document.getElementById('form-producto').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('prod-id').value;
      const nombre = document.getElementById('prod-nombre').value;
      const precio = document.getElementById('prod-precio').value;
      const categoria = document.getElementById('prod-categoria').value;
      const descripcion = document.getElementById('prod-descripcion').value;
      const inputImagen = document.getElementById('prod-imagen');

      if (!nombre || !precio || !categoria) {
        mostrarMensaje('Completa los campos requeridos', 'error');
        return;
      }

      if (inputImagen.files.length === 0 && !id) {
        mostrarMensaje('Selecciona una imagen', 'error');
        return;
      }

      if (inputImagen.files.length > 0) {
        convertirImagenABase64(inputImagen.files[0], function(base64) {
          if (id) {
            DataManager.editarProducto(id, nombre, precio, categoria, base64, descripcion);
            mostrarMensaje('Producto actualizado', 'exito');
          } else {
            DataManager.agregarProducto(nombre, precio, categoria, base64, descripcion);
            mostrarMensaje('Producto agregado', 'exito');
          }
          limpiarFormProducto();
          mostrarProductos();
        });
      } else if (id) {
        const productos = DataManager.cargarProductos();
        const prod = productos.find(p => p.id === id);
        DataManager.editarProducto(id, nombre, precio, categoria, prod.imagen, descripcion);
        mostrarMensaje('Producto actualizado', 'exito');
        limpiarFormProducto();
        mostrarProductos();
      }
    });

    function cargarSelectCategorias() {
      const categorias = DataManager.cargarCategorias();
      const select = document.getElementById('prod-categoria');
      select.innerHTML = '<option value="">Selecciona una categor√≠a</option>' + 
        categorias.map(cat => `<option value="${cat.nombre}">${cat.nombre}</option>`).join('');
    }

    function mostrarProductos() {
      const productos = DataManager.cargarProductos();
      const contenedor = document.getElementById('lista-productos');

      if (productos.length === 0) {
        contenedor.innerHTML = '<div class="sin-contenido">No hay productos a√∫n</div>';
        return;
      }

      contenedor.innerHTML = productos.map(prod => `
        <div class="item-card">
          <img src="${prod.imagen}" alt="${prod.nombre}" class="item-imagen">
          <div class="item-titulo">${prod.nombre}</div>
          <div class="item-info">
            <strong>$${parseFloat(prod.precio).toFixed(2)}</strong><br>
            ${prod.categoria}
          </div>
          <div class="btn-acciones">
            <button class="btn-editar" onclick="editarProducto('${prod.id}')">Editar</button>
            <button class="btn-eliminar" onclick="eliminarProducto('${prod.id}')">Eliminar</button>
          </div>
        </div>
      `).join('');
    }

    function editarProducto(id) {
      const productos = DataManager.cargarProductos();
      const prod = productos.find(p => p.id === id);
      
      cargarSelectCategorias(); // Cargar categor√≠as primero
      
      document.getElementById('prod-id').value = id;
      document.getElementById('prod-nombre').value = prod.nombre;
      document.getElementById('prod-precio').value = prod.precio;
      document.getElementById('prod-categoria').value = prod.categoria;
      document.getElementById('prod-descripcion').value = prod.descripcion;
      document.getElementById('prod-preview').src = prod.imagen;
      document.getElementById('prod-preview').style.display = 'block';
      document.getElementById('btn-guardar-prod').textContent = 'Actualizar producto';
      document.getElementById('btn-cancelar-prod').style.display = 'block';
      
      editandoProducto = id;
      cambiarTab('productos');
      window.scrollTo(0, 0);
    }

    function eliminarProducto(id) {
      if (confirm('¬øEliminar este producto?')) {
        DataManager.eliminarProducto(id);
        mostrarMensaje('Producto eliminado', 'exito');
        mostrarProductos();
      }
    }

    function limpiarFormProducto() {
      document.getElementById('form-producto').reset();
      document.getElementById('prod-id').value = '';
      document.getElementById('prod-preview').style.display = 'none';
      document.getElementById('btn-guardar-prod').textContent = 'Agregar producto';
      document.getElementById('btn-cancelar-prod').style.display = 'none';
      editandoProducto = null;
    }

    // Previsualizaci√≥n de im√°genes
    document.getElementById('cat-imagen').addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('cat-preview').src = event.target.result;
          document.getElementById('cat-preview').style.display = 'block';
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });

    document.getElementById('prod-imagen').addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('prod-preview').src = event.target.result;
          document.getElementById('prod-preview').style.display = 'block';
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });

    // Inicializar con categor√≠as por defecto si no hay ninguna
    function inicializarCategoriasDefault() {
      const categorias = DataManager.cargarCategorias();
      if (categorias.length === 0) {
        const categoriasDefault = [
          { id: '1', nombre: 'Electr√≥nica', imagen: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f358ba" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" text-anchor="middle" dominant-baseline="middle" fill="white"%3Eüîå%3C/text%3E%3C/svg%3E' },
          { id: '2', nombre: 'Juguetes', imagen: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f358ba" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" text-anchor="middle" dominant-baseline="middle" fill="white"%3EüéÆ%3C/text%3E%3C/svg%3E' },
          { id: '3', nombre: '√ötiles', imagen: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f358ba" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" text-anchor="middle" dominant-baseline="middle" fill="white"%3E‚úèÔ∏è%3C/text%3E%3C/svg%3E' },
          { id: '4', nombre: 'Hogar', imagen: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f358ba" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" text-anchor="middle" dominant-baseline="middle" fill="white"%3Eüè†%3C/text%3E%3C/svg%3E' },
          { id: '5', nombre: 'Bazar', imagen: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f358ba" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" text-anchor="middle" dominant-baseline="middle" fill="white"%3Eüõí%3C/text%3E%3C/svg%3E' },
          { id: '6', nombre: 'Blanquer√≠a', imagen: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f358ba" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" text-anchor="middle" dominant-baseline="middle" fill="white"%3EüõèÔ∏è%3C/text%3E%3C/svg%3E' },
          { id: '7', nombre: 'Freidoras de aire', imagen: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f358ba" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" text-anchor="middle" dominant-baseline="middle" fill="white"%3Eüçü%3C/text%3E%3C/svg%3E' },
          { id: '8', nombre: 'Droguer√≠a', imagen: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f358ba" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" text-anchor="middle" dominant-baseline="middle" fill="white"%3Eüíä%3C/text%3E%3C/svg%3E' }
        ];
        DataManager.guardarCategorias(categoriasDefault);
      }
    }

    // Verificar autenticaci√≥n
    function verificarAutenticacion() {
      const sesion = sessionStorage.getItem('micasita_admin_auth');
      if (sesion !== 'true') {
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    // Cerrar sesi√≥n
    function logout() {
      if (confirm('¬øDeseas cerrar sesi√≥n?')) {
        sessionStorage.removeItem('micasita_admin_auth');
        window.location.href = 'login.html';
      }
    }

    // Cargar datos al iniciar
    if (verificarAutenticacion()) {
      inicializarCategoriasDefault();
      mostrarCategorias();
    }
  </script>
</body>
</html>
